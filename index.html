<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }

    #hud {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 999;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
    }

    .hud-row {
      pointer-events: auto;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.55);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      box-sizing: border-box;
    }

    /* ── Shape buttons ── */
    .shape-btn {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: bold;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 8px;
      background: rgba(0,0,0,0.5);
      color: white;
      cursor: pointer;
    }
    .shape-btn.active {
      background: rgba(41,121,255,0.85);
      border-color: #2979ff;
    }

    /* ── Colour swatches ── */
    .swatch {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      flex-shrink: 0;
    }
    .swatch.active {
      border-color: white;
      transform: scale(1.2);
    }

    /* Native colour wheel — styled as a round swatch */
    #color-custom {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.5);
      background: none;
      cursor: pointer;
      padding: 0;
      overflow: hidden;
      -webkit-appearance: none;
      appearance: none;
    }
    #color-custom::-webkit-color-swatch-wrapper { padding: 0; }
    #color-custom::-webkit-color-swatch { border: none; border-radius: 50%; }

    /* ── Slider row ── */
    .hud-row label {
      color: rgba(255,255,255,0.75);
      font-size: 12px;
      white-space: nowrap;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 130px; height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.25);
      outline: none;
      cursor: pointer;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: #2979ff;
      cursor: pointer;
    }

    /* ── Rotation toggle ── */
    #rot-btn {
      padding: 7px 14px;
      font-size: 12px;
      font-weight: bold;
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 8px;
      background: rgba(0,0,0,0.5);
      color: white;
      cursor: pointer;
    }
    #rot-btn.spinning {
      border-color: #00e676;
      color: #00e676;
    }
  </style>
</head>
<body>

  <div id="hud">

    <!-- Row 1: Shape picker -->
    <div class="hud-row">
      <button class="shape-btn active" id="btn-box"      onclick="showShape('box')">Cube</button>
      <button class="shape-btn"        id="btn-sphere"   onclick="showShape('sphere')">Sphere</button>
      <button class="shape-btn"        id="btn-cylinder" onclick="showShape('cylinder')">Cylinder</button>
      <button class="shape-btn"        id="btn-torus"    onclick="showShape('torus')">Torus</button>
    </div>

    <!-- Row 2: Colour swatches + full colour wheel -->
    <div class="hud-row">
      <div class="swatch active" style="background:#2979ff" onclick="setColor('#2979ff',this)"></div>
      <div class="swatch"        style="background:#ff1744" onclick="setColor('#ff1744',this)"></div>
      <div class="swatch"        style="background:#00e676" onclick="setColor('#00e676',this)"></div>
      <div class="swatch"        style="background:#ffd740" onclick="setColor('#ffd740',this)"></div>
      <div class="swatch"        style="background:#e040fb" onclick="setColor('#e040fb',this)"></div>
      <div class="swatch"        style="background:#ffffff" onclick="setColor('#ffffff',this)"></div>
      <input type="color" id="color-custom" value="#2979ff" title="Custom colour"
             oninput="setColor(this.value, this)">
    </div>

    <!-- Row 3: Scale slider + Rotation toggle -->
    <div class="hud-row">
      <label for="scale-slider">Size</label>
      <input type="range" id="scale-slider"
             min="0.1" max="1.2" step="0.01" value="0.5"
             oninput="setScale(this.value)">
      <button id="rot-btn" class="spinning" onclick="toggleRotation()">⟳ Spin ON</button>
    </div>

  </div>

  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">

    <a-marker preset="hiro">

      <!--
        FIX: Use pauseEvents and resumeEvents instead of setAttribute('animation','paused',...).

        The bug: setAttribute on the animation component goes through A-Frame's
        diff system. If the value hasn't changed (e.g. paused=false → paused=false),
        A-Frame treats it as a duplicate and the animation component never sees it.
        This is why rotation broke permanently after the first toggle.

        The fix: declare pauseEvents and resumeEvents on the animation upfront.
        Then control it with el.emit('pauseAnim') / el.emit('playAnim').
        emit() bypasses the diff system entirely — the event always fires,
        so the animation always responds correctly.
      -->

      <a-box
        id="shape-box"
        position="0 0.25 0"
        scale="0.5 0.5 0.5"
        color="#2979ff"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear;
                   pauseEvents: pauseAnim; resumeEvents: playAnim"
        visible="true">
      </a-box>

      <a-sphere
        id="shape-sphere"
        position="0 0.3 0"
        radius="0.3"
        scale="0.5 0.5 0.5"
        color="#2979ff"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear;
                   pauseEvents: pauseAnim; resumeEvents: playAnim"
        visible="false">
      </a-sphere>

      <a-cylinder
        id="shape-cylinder"
        position="0 0.3 0"
        radius="0.25"
        height="0.5"
        scale="0.5 0.5 0.5"
        color="#2979ff"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear;
                   pauseEvents: pauseAnim; resumeEvents: playAnim"
        visible="false">
      </a-cylinder>

      <a-torus
        id="shape-torus"
        position="0 0.3 0"
        radius="0.28"
        radius-tubular="0.08"
        scale="0.5 0.5 0.5"
        color="#2979ff"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear;
                   pauseEvents: pauseAnim; resumeEvents: playAnim"
        visible="false">
      </a-torus>

    </a-marker>

    <a-entity camera></a-entity>

  </a-scene>

  <script>
    var shapes   = ['box', 'sphere', 'cylinder', 'torus'];
    var spinning = true;

    // ── Shape switcher ───────────────────────────────────
    function showShape(name) {
      shapes.forEach(function(id) {
        var el  = document.getElementById('shape-' + id);
        var btn = document.getElementById('btn-' + id);
        var isTarget = (id === name);

        el.setAttribute('visible', isTarget);
        btn.classList.toggle('active', isTarget);

        // When switching to a shape, apply the current spin state to it
        // using emit — same reliable path as the toggle button uses
        if (isTarget) {
          el.emit(spinning ? 'playAnim' : 'pauseAnim');
        }
      });
    }

    // ── Colour ───────────────────────────────────────────
    function setColor(hex, swatchEl) {
      shapes.forEach(function(id) {
        document.getElementById('shape-' + id)
                .setAttribute('material', 'color', hex);
      });

      document.querySelectorAll('.swatch').forEach(function(s) {
        s.classList.remove('active');
      });
      if (swatchEl.classList && swatchEl.classList.contains('swatch')) {
        swatchEl.classList.add('active');
      }
    }

    // ── Scale ────────────────────────────────────────────
    function setScale(val) {
      var s = parseFloat(val);
      shapes.forEach(function(id) {
        document.getElementById('shape-' + id).object3D.scale.set(s, s, s);
      });
    }

    // ── Rotation toggle ──────────────────────────────────
    function toggleRotation() {
      spinning = !spinning;

      shapes.forEach(function(id) {
        // emit() goes directly to the animation component's event listener —
        // it does not go through setAttribute's diff check, so it always fires
        document.getElementById('shape-' + id)
                .emit(spinning ? 'playAnim' : 'pauseAnim');
      });

      var btn = document.getElementById('rot-btn');
      btn.textContent = spinning ? '⟳ Spin ON' : '⏸ Spin OFF';
      btn.classList.toggle('spinning', spinning);
    }
  </script>

</body>
</html>
